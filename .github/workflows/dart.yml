name: Build iOS IPA

on:
  workflow_dispatch:

jobs:
  build:
    name: üì± iOS Build (No Codesign)
    runs-on: macos-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: "3.19.0"
          channel: stable

      - name: Flutter doctor
        run: flutter doctor -v

      - name: Get dependencies
        run: flutter pub get

      - name: Dependency status (compact)
        run: flutter pub outdated
        continue-on-error: true

      - name: Install CocoaPods dependencies
        run: |
          pod repo update
          pod install
        working-directory: ios

      # –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ —Ä–µ–∞–ª—å–Ω—ã—Ö build settings (–ø–æ–º–æ–≥–∞–µ—Ç –ø–æ–Ω—è—Ç—å, –∫—Ç–æ –≤–∫–ª—é—á–∞–µ—Ç –ø–æ–¥–ø–∏—Å—å)
      - name: Show signing build settings (Release)
        run: |
          xcodebuild -showBuildSettings -workspace Runner.xcworkspace -scheme Runner -configuration Release | grep -E 'CODE_SIGN|DEVELOPMENT_TEAM|PROVISION' || true
        working-directory: ios

      # –ê—Ä—Ö–∏–≤–∏—Ä–æ–≤–∞–Ω–∏–µ —á–µ—Ä–µ–∑ xcodebuild –±–µ–∑ –ø–æ–¥–ø–∏—Å–∏ (–≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Å–ø–æ—Å–æ–± –ø–æ–ª—É—á–∏—Ç—å Runner.app)
      - name: Xcode archive (unsigned)
        run: |
          xcodebuild -workspace Runner.xcworkspace -scheme Runner -configuration Release \
            -archivePath ../build/Runner.xcarchive -destination 'generic/platform=iOS' \
            CODE_SIGNING_ALLOWED=NO CODE_SIGNING_REQUIRED=NO CODE_SIGN_STYLE=Manual \
            CODE_SIGN_IDENTITY="" DEVELOPMENT_TEAM="" PROVISIONING_PROFILE_SPECIFIER="" \
            archive
        working-directory: ios

      - name: Create Payload directory
        run: mkdir -p Payload

      - name: Copy app to Payload
        run: cp -R build/Runner.xcarchive/Products/Applications/Runner.app Payload/

      - name: Create IPA archive
        run: zip -r app.ipa Payload

      - name: Upload IPA artifact
        uses: actions/upload-artifact@v4
        with:
          name: ios-ipa
          path: app.ipa
